generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Weekday {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExamType {
  MIDTERM
  FINAL
  QUIZ
  PROJECT
  PRESENTATION
  ASSIGNMENT
  OTHER
}

enum ExamStatus {
  SCHEDULED
  COMPLETED
  MISSED
}

enum PlannerStatus {
  TODO
  IN_PROGRESS
  DONE
  ARCHIVED
}

enum PlannerPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PlannerCadence {
  DAILY
  WEEKLY
  MONTHLY
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String
  passwordHash String
  studentId    String?
  university   String?
  major        String?
  currentTerm  String?
  bio          String?
  avatarUrl    String?
  semesters    Semester[]
  courses      Course[]
  exams        Exam[]
  plannerItems PlannerItem[]
  events       StudentEvent[]
  folders      Folder[]
  files        FileAsset[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Semester {
  id           String        @id @default(cuid())
  userId       String
  title        String
  code         String?
  startDate    DateTime
  endDate      DateTime
  isCurrent    Boolean       @default(false)
  isPinned     Boolean       @default(false)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses      Course[]
  exams        Exam[]
  plannerItems PlannerItem[]
  files        FileAsset[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([userId, isCurrent])
  @@index([userId, startDate])
}

model Course {
  id           String         @id @default(cuid())
  userId       String
  semesterId   String
  name         String
  code         String?
  instructor   String?
  location     String?
  credits      Int?
  color        String?
  isPinned     Boolean        @default(false)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  semester     Semester       @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  sessions     CourseSession[]
  exams        Exam[]
  plannerItems PlannerItem[]
  files        FileAsset[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([userId, semesterId])
  @@index([semesterId])
}

model CourseSession {
  id        String   @id @default(cuid())
  courseId  String
  weekday   Weekday
  startTime String
  endTime   String
  room      String?
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId, weekday, startTime])
}

model Exam {
  id              String     @id @default(cuid())
  userId          String
  semesterId      String?
  courseId        String?
  title           String
  examType        ExamType   @default(OTHER)
  status          ExamStatus @default(SCHEDULED)
  examDate        DateTime
  startTime       String?
  durationMinutes Int?
  location        String?
  notes           String?
  isPinned        Boolean    @default(false)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  semester        Semester?  @relation(fields: [semesterId], references: [id], onDelete: SetNull)
  course          Course?    @relation(fields: [courseId], references: [id], onDelete: SetNull)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([userId, examDate, status])
  @@index([semesterId])
  @@index([courseId])
}

model PlannerItem {
  id          String          @id @default(cuid())
  userId      String
  semesterId  String?
  courseId    String?
  title       String
  description String?
  status      PlannerStatus   @default(TODO)
  priority    PlannerPriority @default(MEDIUM)
  cadence     PlannerCadence  @default(DAILY)
  plannedFor  DateTime?
  startAt     DateTime?
  dueAt       DateTime?
  isPinned    Boolean         @default(false)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  semester    Semester?       @relation(fields: [semesterId], references: [id], onDelete: SetNull)
  course      Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull)
  files       FileAsset[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId, status, priority])
  @@index([semesterId])
  @@index([courseId])
  @@index([dueAt])
  @@index([userId, cadence, plannedFor])
}

model StudentEvent {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  location    String?
  startAt     DateTime
  endAt       DateTime?
  isPinned    Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, startAt])
  @@index([userId, isPinned])
}

model Folder {
  id        String     @id @default(cuid())
  userId    String
  parentId  String?
  name      String
  color     String?
  isPinned  Boolean    @default(false)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Folder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Folder[]   @relation("FolderHierarchy")
  files     FileAsset[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId, parentId, name])
}

model FileAsset {
  id            String       @id @default(cuid())
  originalName  String
  storageName   String       @unique
  mimeType      String
  size          Int
  uploadedById  String
  folderId      String?
  semesterId    String?
  courseId      String?
  plannerItemId String?
  isPinned      Boolean      @default(false)
  tags          Json?
  uploadedBy    User         @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  folder        Folder?      @relation(fields: [folderId], references: [id], onDelete: SetNull)
  semester      Semester?    @relation(fields: [semesterId], references: [id], onDelete: SetNull)
  course        Course?      @relation(fields: [courseId], references: [id], onDelete: SetNull)
  plannerItem   PlannerItem? @relation(fields: [plannerItemId], references: [id], onDelete: SetNull)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([uploadedById, createdAt])
  @@index([folderId])
  @@index([courseId])
  @@index([semesterId])
  @@index([plannerItemId])
}
